#cloud-config
# =============================================================================
# Cloud-Init: NTP Server (time.bauer-group.com)
# =============================================================================
# Chrony-basierter NTP Server mit automatischen OS-Updates.
# Verwendung: Als user-data bei VM-Erstellung angeben.
# Getestet fuer: Ubuntu 24.04+ / Debian 13+
# =============================================================================

hostname: time.bauer-group.com

timezone: Etc/UTC

locale: en_US.UTF-8

# --- Benutzer (optional) -----------------------------------------------------
# Einkommentieren und SSH-Key anpassen um eigenen Benutzer zu erstellen.
# Ohne diesen Block wird der Standard-User des Cloud-Images verwendet.
#users:
#  - name: admin
#    groups: sudo
#    sudo: ALL=(ALL) NOPASSWD:ALL
#    shell: /bin/bash
#    lock_passwd: true
#    ssh_authorized_keys:
#      - ssh-ed25519 AAAA...DEIN_PUBLIC_KEY...== admin@bauer-group.com
#
#ssh_pwauth: false

# --- Paketquellen aktualisieren und Pakete installieren ----------------------
package_update: true
package_upgrade: true
package_reboot_if_required: true

packages:
  - chrony
  - unattended-upgrades
  - apt-listchanges
  - needrestart

# --- NTP (Chrony) Konfiguration ---------------------------------------------
write_files:
  # Chrony Hauptkonfiguration
  - path: /etc/chrony/chrony.conf
    owner: root:root
    permissions: "0644"
    content: |
      # =======================================================================
      # Chrony NTP Server - time.bauer-group.com
      # =======================================================================

      # Upstream NTP Server (deutsche Zeitquellen)
      server ptbtime1.ptb.de iburst prefer
      server ptbtime2.ptb.de iburst
      server ptbtime3.ptb.de iburst
      server ntps1-0.eecsit.tu-berlin.de iburst
      server ntp1.fau.de iburst
      server zeit.fu-berlin.de iburst

      # Zeitdifferenz-Datei (fuer Neustarts)
      driftfile /var/lib/chrony/chrony.drift

      # Messdaten ueber Neustarts persistieren
      dumpdir /var/lib/chrony

      # NTP-Dienst fuer alle Clients bereitstellen
      allow all

      # Rate Limiting: Schutz vor Amplification-Angriffen (Pool-tauglich)
      # interval -4 = min. 1/16 Sek. zwischen Paketen pro Client (~16 Pkt/Sek)
      # burst 16 = kurze Bursts erlauben, leak 2 = sanftes Throttling
      ratelimit interval -4 burst 16 leak 2

      # Client-Log: 128 MB = ca. 2 Mio. Clients (fuer NTP Pool ausreichend)
      clientloglimit 134217728

      # Logging
      log tracking measurements statistics
      logdir /var/log/chrony

      # RTC (Hardware-Uhr) synchronisieren
      rtcsync

      # Grosse Zeitspruenge beim Start erlauben (erste 3 Updates)
      makestep 1.0 3

      # Leap-Second-Handling
      leapsectz right/UTC

  # Unattended-Upgrades: Alle Updates automatisch installieren
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root:root
    permissions: "0644"
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}:${distro_codename}-updates";
          "${distro_id}ESMApps:${distro_codename}-apps-security";
          "${distro_id}ESM:${distro_codename}-infra-security";
      };

      // Alle installierten Pakete aktualisieren (nicht nur Sicherheit)
      Unattended-Upgrade::DevRelease "auto";

      // Automatischer Reboot wenn noetig (03:25 Uhr, nach apt-daily-upgrade)
      Unattended-Upgrade::Automatic-Reboot "true";
      Unattended-Upgrade::Automatic-Reboot-Time "03:25";

      // Ungenutzte Abhaengigkeiten entfernen
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Remove-New-Unused-Dependencies "true";

      // Syslog-Logging
      Unattended-Upgrade::SyslogEnable "true";

  # Unattended-Upgrades: Auto-Update Intervall
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root:root
    permissions: "0644"
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";

  # needrestart: Automatischer Restart von Diensten nach Updates
  - path: /etc/needrestart/conf.d/auto-restart.conf
    owner: root:root
    permissions: "0644"
    content: |
      $nrconf{restart} = 'a';

  # systemd Timer: apt-daily auf 03:00 UTC legen (Paketlisten aktualisieren)
  - path: /etc/systemd/system/apt-daily.timer.d/override.conf
    owner: root:root
    permissions: "0644"
    content: |
      [Timer]
      OnCalendar=
      OnCalendar=*-*-* 03:00
      RandomizedDelaySec=0

  # systemd Timer: apt-daily-upgrade auf 03:10 UTC legen (Pakete installieren)
  - path: /etc/systemd/system/apt-daily-upgrade.timer.d/override.conf
    owner: root:root
    permissions: "0644"
    content: |
      [Timer]
      OnCalendar=
      OnCalendar=*-*-* 03:10
      RandomizedDelaySec=0

  # Login-Banner: NTP-Status bei SSH-Login anzeigen
  - path: /etc/update-motd.d/60-ntp-status
    owner: root:root
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      # NTP Server Status - Login Banner

      echo ""
      echo "========================================"
      echo "  $(hostname) — NTP Server"
      echo "========================================"
      echo ""

      # --- Sync-Status ---
      tracking=$(chronyc tracking 2>/dev/null)
      if [ $? -eq 0 ]; then
          source=$(echo "$tracking" | awk -F': ' '/^Reference ID/{print $2}')
          stratum=$(echo "$tracking" | awk -F': ' '/^Stratum/{print $2}')
          offset=$(echo "$tracking" | awk -F': ' '/^Last offset/{print $2}')
          leap=$(echo "$tracking" | awk -F': ' '/^Leap status/{print $2}')

          printf "  %-18s %s\n" "Sync-Quelle:" "$source"
          printf "  %-18s %s\n" "Stratum:" "$stratum"
          printf "  %-18s %s\n" "Offset:" "$offset"
          printf "  %-18s %s\n" "Leap-Status:" "$leap"
      else
          echo "  Chrony nicht erreichbar"
      fi

      echo ""
      echo "  Upstream-Quellen:"
      echo "  ----------------------------------------"
      chronyc sources 2>/dev/null | grep '^\^' | while read -r line; do
          echo "  $line"
      done

      echo ""
      printf "  %-18s %s\n" "Wartungsfenster:" "03:00-03:30 UTC"
      printf "  %-18s %s\n" "Chrony-Log:" "/var/log/chrony/"
      echo ""

  # snapd-Neuinstallation verhindern
  - path: /etc/apt/preferences.d/no-snapd
    owner: root:root
    permissions: "0644"
    content: |
      Package: snapd
      Pin: release *
      Pin-Priority: -1

# --- Befehle nach der Installation ------------------------------------------
runcmd:
  # Standard-NTP-Dienste und unnoetige Pakete entfernen
  - systemctl stop systemd-timesyncd || true
  - systemctl disable systemd-timesyncd || true
  - apt-get remove -y -q --purge ntp ntpsec snapd modemmanager udisks2 multipath-tools policykit-1 polkitd packagekit networkd-dispatcher || true
  - apt-get autoremove -y -q
  - rm -rf /snap /var/snap /var/lib/snapd /var/cache/snapd || true

  # Chrony aktivieren und starten
  - systemctl enable chrony
  - systemctl restart chrony

  # Unattended-Upgrades aktivieren
  - systemctl enable unattended-upgrades
  - systemctl restart unattended-upgrades

  # Timer-Overrides laden und aktivieren
  - mkdir -p /etc/systemd/system/apt-daily.timer.d
  - mkdir -p /etc/systemd/system/apt-daily-upgrade.timer.d
  - systemctl daemon-reload
  - systemctl enable apt-daily.timer
  - systemctl enable apt-daily-upgrade.timer

  # Initiale Zeitsynchronisation erzwingen
  - chronyc makestep

  # Standard-MOTD aufraeumen (Werbung, irrelevante Hinweise)
  - chmod -x /etc/update-motd.d/10-help-text 2>/dev/null || true
  - chmod -x /etc/update-motd.d/50-motd-news 2>/dev/null || true
  - chmod -x /etc/update-motd.d/85-fwupd 2>/dev/null || true
  - chmod -x /etc/update-motd.d/88-esm-announce 2>/dev/null || true
  - chmod -x /etc/update-motd.d/90-updates-available 2>/dev/null || true
  - chmod -x /etc/update-motd.d/91-contract-ua-esm-status 2>/dev/null || true
  - chmod -x /etc/update-motd.d/95-hwe-eol 2>/dev/null || true
  - chmod -x /etc/update-motd.d/97-overlayroot 2>/dev/null || true

# --- Endgueltige Nachricht --------------------------------------------------
final_message: "NTP Server Setup abgeschlossen nach $UPTIME Sekunden. Neustart in 1 Minute..."

# --- Neustart nach Setup ----------------------------------------------------
power_state:
  mode: reboot
  delay: "+1"
  message: "NTP Server Setup abgeschlossen — Neustart fuer sauberen Zustand."
